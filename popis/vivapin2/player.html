<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <script>
    (function(){
      try{
        if(!sessionStorage.getItem('player_refreshed')){
          sessionStorage.setItem('player_refreshed','1');
          setTimeout(function(){
            location.replace('player.html?r=1');
          },700);
        }
      }catch(e){
        location.replace('player.html?r=1');
      }
    })();
  </script>

  <title>Audio Player</title>
  <style>
    body {
      margin: 0;
      background-color: black;
    }
    .player {
      width: 940px;
      height: 128px;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 20px 10px black;
    }
    /* drobn√Ω vizu√°ln√≠ hint (nepovinn√©) */
    .hint {
      position: absolute;
      left: 12px;
      top: 8px;
      color: rgba(255,255,255,0.7);
      font-size:12px;
      font-family: Arial, sans-serif;
      pointer-events: none;
    }
  </style>
</head>
<body>

<div id="playerContainer"></div>

<script>
  // prim√°rn√≠ embed: autoplay=true + muted=1 -> vy≈°≈°√≠ ≈°ance, ≈æe to prohl√≠≈æeƒç pust√≠ automaticky
  const PRIMARY_URL = "https://fmcloud.pro/embed.php?id=357&autoplay=true=1";
  const PRIMARY_URL_UNMUTED = "https://fmcloud.pro/embed.php?id=357&autoplay=trueted=0";
  const BACKUP_URL = "https://trolltrolli.github.io/skt/popis/vivapin2/player_backup.html?autoplay=true";
  const TIMEOUT = 3000;

  const container = document.getElementById('playerContainer');
  let mp3Ok = false;
  let userGestureDone = false;
  let currentSrc = PRIMARY_URL;

  function createIframe(src) {
    const iframe = document.createElement('iframe');
    iframe.src = src;
    iframe.allow = "autoplay";
    iframe.className = "player";
    iframe.setAttribute('sandbox',''); // pokud by f√≥rum p≈ôidalo sandbox, nech√°me to zde pr√°zdn√© (nen√≠ to nutn√©)
    return iframe;
  }

  function loadIframe(src) {
    currentSrc = src;
    container.innerHTML = "";
    container.appendChild(createIframe(src));
  }

  // Spust√≠me p≈ôehr√°vaƒç (muted autoplay pokus)
  loadIframe(PRIMARY_URL);

  // Poslouch√°me zpr√°vy z embed playeru (pokud embed nƒõjak√© pos√≠l√°)
  window.addEventListener("message", (event) => {
    // bezpeƒçnost: event.origin lze v budoucnu zkontrolovat proti seznamu povolen√Ωch dom√©n
    if (event.data?.mp3_status === "ok") {
      console.log("‚úÖ MP3 potvrzena z embed ‚Äì nech√°v√°m prim√°rn√≠ player.");
      mp3Ok = true;
    }
    // nƒõkter√© embedy mohou ozn√°mit, ≈æe zaƒçaly p≈ôehr√°vat atd.
    if (event.data?.action === "played") {
      console.log("‚ÑπÔ∏è Embed hl√°s√≠ p≈ôehr√°v√°n√≠.");
      mp3Ok = true;
    }
  });

  // Po timeoutu zkontrolujeme, jestli nep≈ôi≈°la zpr√°va ‚Äì pokud ne, p≈ôepneme na z√°lo≈æn√≠
  setTimeout(() => {
    if (!mp3Ok) {
      console.log("‚ùå ≈Ω√°dn√© potvrzen√≠ o MP3 ‚Äì p≈ôep√≠n√°m na z√°lo≈æn√≠ player.");
      loadIframe(BACKUP_URL);
    }
  }, TIMEOUT);

  // --- AUTOPLAY hack: ƒçek√°me na prvn√≠ user gesture a pak se pokus√≠me o full-volume play ---
  function onFirstUserGesture() {
    if (userGestureDone) return;
    userGestureDone = true;
    console.log("üîî U≈æivatelsk√© gesto detekov√°no ‚Äì pokus√≠m se o pln√Ω zvuk.");

    // 1) pokus√≠me se poslat postMessage do embedu (pokud poslouch√°)
    try {
      const iframe = container.querySelector('iframe.player');
      if (iframe && iframe.contentWindow) {
        // standardn√≠ "play" action, embed mus√≠ podporovat postMessage API
        iframe.contentWindow.postMessage({ action: 'play' }, '*');
        iframe.contentWindow.postMessage({ action: 'unmute' }, '*');
      }
    } catch (e) {
      console.warn('postMessage selhalo', e);
    }

    // 2) pokus√≠me se iframe nahradit verz√≠ bez muted parametru (reload -> nƒõkter√© embedy pak pust√≠ zvuk)
    // jen pokud jsme st√°le na prim√°rn√≠ URL s muted=1
    try {
      if (currentSrc === PRIMARY_URL) {
        // kr√°tk√© zpo≈ædƒõn√≠, aby prohl√≠≈æeƒç uznal gesto
        setTimeout(() => {
          loadIframe(PRIMARY_URL_UNMUTED);
        }, 120);
      }
    } catch(e) {
      console.warn('reload unmute selhalo', e);
    }
  }

  // poslouch√°me v√≠cero typ≈Ø gest, aby to chytilo i mobil
  ['click','touchstart','keydown'].forEach(evt => {
    window.addEventListener(evt, onFirstUserGesture, { once: true, passive: true });
  });

  // U≈æivatel si m≈Ø≈æe cht√≠t explicitnƒõ kliknout i na box
  container.addEventListener('click', onFirstUserGesture);

</script>

</body>
</html>
